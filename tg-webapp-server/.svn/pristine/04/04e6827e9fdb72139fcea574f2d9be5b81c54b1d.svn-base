<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.plou.web.charge.chargeconfig.dao.BankReconciliationsDetailMapper">
    <resultMap id="BaseResultMap" type="cn.plou.web.charge.chargeconfig.entity.BankReconciliationsDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="primary_id" jdbcType="VARCHAR" property="primaryId"/>
        <result column="company_id" jdbcType="VARCHAR" property="companyId"/>
        <result column="annual" jdbcType="VARCHAR" property="annual"/>
        <result column="bank_id" jdbcType="VARCHAR" property="bankId"/>
        <result column="platform_code" jdbcType="VARCHAR" property="platformCode"/>
        <result column="consumer_id" jdbcType="VARCHAR" property="consumerId"/>
        <result column="third_party_flow_code" jdbcType="VARCHAR" property="thirdPartyFlowCode"/>
        <result column="pay_date" jdbcType="TIMESTAMP" property="payDate"/>
        <result column="pay_money" jdbcType="DECIMAL" property="payMoney"/>
        <result column="operator_code" jdbcType="VARCHAR" property="operatorCode"/>
        <result column="operator_area" jdbcType="VARCHAR" property="operatorArea"/>
        <result column="pay_mode" jdbcType="VARCHAR" property="payMode"/>
        <result column="push_tel" jdbcType="VARCHAR" property="pushTel"/>
        <result column="push_mail" jdbcType="VARCHAR" property="pushMail"/>
        <result column="reconciliations_flag" jdbcType="VARCHAR" property="reconciliationsFlag"/>
        <result column="notes" jdbcType="VARCHAR" property="notes"/>
        <result column="memo1" jdbcType="VARCHAR" property="memo1"/>
        <result column="memo2" jdbcType="VARCHAR" property="memo2"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="create_user" jdbcType="VARCHAR" property="createUser"/>
        <result column="update_date" jdbcType="TIMESTAMP" property="updateDate"/>
        <result column="update_user" jdbcType="VARCHAR" property="updateUser"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        primary_id, company_id, annual, bank_id, platform_code, consumer_id, third_party_flow_code,
        pay_date, pay_money, operator_code, operator_area, pay_mode, push_tel, push_mail,
        reconciliations_flag, notes, memo1, memo2, create_date, create_user, update_date,
        update_user
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from bank_reconciliations_detail
        where primary_id = #{primaryId,jdbcType=VARCHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from bank_reconciliations_detail
        where primary_id = #{primaryId,jdbcType=VARCHAR}
    </delete>
    <insert id="insert" parameterType="cn.plou.web.charge.chargeconfig.entity.BankReconciliationsDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into bank_reconciliations_detail (primary_id, company_id, annual,
        bank_id, platform_code, consumer_id,
        third_party_flow_code, pay_date, pay_money,
        operator_code, operator_area, pay_mode,
        push_tel, push_mail, reconciliations_flag,
        notes, memo1, memo2,
        create_date, create_user, update_date,
        update_user)
        values (#{primaryId,jdbcType=VARCHAR}, #{companyId,jdbcType=VARCHAR}, #{annual,jdbcType=VARCHAR},
        #{bankId,jdbcType=VARCHAR}, #{platformCode,jdbcType=VARCHAR}, #{consumerId,jdbcType=VARCHAR},
        #{thirdPartyFlowCode,jdbcType=VARCHAR}, #{payDate,jdbcType=TIMESTAMP}, #{payMoney,jdbcType=DECIMAL},
        #{operatorCode,jdbcType=VARCHAR}, #{operatorArea,jdbcType=VARCHAR}, #{payMode,jdbcType=VARCHAR},
        #{pushTel,jdbcType=VARCHAR}, #{pushMail,jdbcType=VARCHAR}, #{reconciliationsFlag,jdbcType=VARCHAR},
        #{notes,jdbcType=VARCHAR}, #{memo1,jdbcType=VARCHAR}, #{memo2,jdbcType=VARCHAR},
        #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}, #{updateDate,jdbcType=TIMESTAMP},
        #{updateUser,jdbcType=VARCHAR})
    </insert>
    <insert id="insertBatch" parameterType="java.util.List">
        insert into bank_reconciliations_detail (primary_id, company_id, annual,
        bank_id, platform_code, consumer_id,
        third_party_flow_code, pay_date, pay_money,
        operator_code, operator_area, pay_mode,
        push_tel, push_mail, reconciliations_flag,
        notes, memo1, memo2,
        create_date, create_user, update_date,
        update_user)
        values
        <foreach collection="list" item="detail" index="index" separator=",">
            (#{detail.primaryId,jdbcType=VARCHAR}, #{detail.companyId,jdbcType=VARCHAR}, #{detail.annual,jdbcType=VARCHAR},
            #{detail.bankId,jdbcType=VARCHAR}, #{detail.platformCode,jdbcType=VARCHAR}, #{detail.consumerId,jdbcType=VARCHAR},
            #{detail.thirdPartyFlowCode,jdbcType=VARCHAR}, #{detail.payDate,jdbcType=TIMESTAMP}, #{detail.payMoney,jdbcType=DECIMAL},
            #{detail.operatorCode,jdbcType=VARCHAR}, #{detail.operatorArea,jdbcType=VARCHAR}, #{detail.payMode,jdbcType=VARCHAR},
            #{detail.pushTel,jdbcType=VARCHAR}, #{detail.pushMail,jdbcType=VARCHAR}, #{detail.reconciliationsFlag,jdbcType=VARCHAR},
            #{detail.notes,jdbcType=VARCHAR}, #{detail.memo1,jdbcType=VARCHAR}, #{detail.memo2,jdbcType=VARCHAR},
            #{detail.createDate,jdbcType=TIMESTAMP}, #{detail.createUser,jdbcType=VARCHAR}, #{detail.updateDate,jdbcType=TIMESTAMP},
            #{detail.updateUser,jdbcType=VARCHAR})
        </foreach>
    </insert>
    <insert id="insertSelective" parameterType="cn.plou.web.charge.chargeconfig.entity.BankReconciliationsDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into bank_reconciliations_detail
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="primaryId != null">
                primary_id,
            </if>
            <if test="companyId != null">
                company_id,
            </if>
            <if test="annual != null">
                annual,
            </if>
            <if test="bankId != null">
                bank_id,
            </if>
            <if test="platformCode != null">
                platform_code,
            </if>
            <if test="consumerId != null">
                consumer_id,
            </if>
            <if test="thirdPartyFlowCode != null">
                third_party_flow_code,
            </if>
            <if test="payDate != null">
                pay_date,
            </if>
            <if test="payMoney != null">
                pay_money,
            </if>
            <if test="operatorCode != null">
                operator_code,
            </if>
            <if test="operatorArea != null">
                operator_area,
            </if>
            <if test="payMode != null">
                pay_mode,
            </if>
            <if test="pushTel != null">
                push_tel,
            </if>
            <if test="pushMail != null">
                push_mail,
            </if>
            <if test="reconciliationsFlag != null">
                reconciliations_flag,
            </if>
            <if test="notes != null">
                notes,
            </if>
            <if test="memo1 != null">
                memo1,
            </if>
            <if test="memo2 != null">
                memo2,
            </if>
            <if test="createDate != null">
                create_date,
            </if>
            <if test="createUser != null">
                create_user,
            </if>
            <if test="updateDate != null">
                update_date,
            </if>
            <if test="updateUser != null">
                update_user,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="primaryId != null">
                #{primaryId,jdbcType=VARCHAR},
            </if>
            <if test="companyId != null">
                #{companyId,jdbcType=VARCHAR},
            </if>
            <if test="annual != null">
                #{annual,jdbcType=VARCHAR},
            </if>
            <if test="bankId != null">
                #{bankId,jdbcType=VARCHAR},
            </if>
            <if test="platformCode != null">
                #{platformCode,jdbcType=VARCHAR},
            </if>
            <if test="consumerId != null">
                #{consumerId,jdbcType=VARCHAR},
            </if>
            <if test="thirdPartyFlowCode != null">
                #{thirdPartyFlowCode,jdbcType=VARCHAR},
            </if>
            <if test="payDate != null">
                #{payDate,jdbcType=TIMESTAMP},
            </if>
            <if test="payMoney != null">
                #{payMoney,jdbcType=DECIMAL},
            </if>
            <if test="operatorCode != null">
                #{operatorCode,jdbcType=VARCHAR},
            </if>
            <if test="operatorArea != null">
                #{operatorArea,jdbcType=VARCHAR},
            </if>
            <if test="payMode != null">
                #{payMode,jdbcType=VARCHAR},
            </if>
            <if test="pushTel != null">
                #{pushTel,jdbcType=VARCHAR},
            </if>
            <if test="pushMail != null">
                #{pushMail,jdbcType=VARCHAR},
            </if>
            <if test="reconciliationsFlag != null">
                #{reconciliationsFlag,jdbcType=VARCHAR},
            </if>
            <if test="notes != null">
                #{notes,jdbcType=VARCHAR},
            </if>
            <if test="memo1 != null">
                #{memo1,jdbcType=VARCHAR},
            </if>
            <if test="memo2 != null">
                #{memo2,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="createUser != null">
                #{createUser,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updateUser != null">
                #{updateUser,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="cn.plou.web.charge.chargeconfig.entity.BankReconciliationsDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update bank_reconciliations_detail
        <set>
            <if test="companyId != null">
                company_id = #{companyId,jdbcType=VARCHAR},
            </if>
            <if test="annual != null">
                annual = #{annual,jdbcType=VARCHAR},
            </if>
            <if test="bankId != null">
                bank_id = #{bankId,jdbcType=VARCHAR},
            </if>
            <if test="platformCode != null">
                platform_code = #{platformCode,jdbcType=VARCHAR},
            </if>
            <if test="consumerId != null">
                consumer_id = #{consumerId,jdbcType=VARCHAR},
            </if>
            <if test="thirdPartyFlowCode != null">
                third_party_flow_code = #{thirdPartyFlowCode,jdbcType=VARCHAR},
            </if>
            <if test="payDate != null">
                pay_date = #{payDate,jdbcType=TIMESTAMP},
            </if>
            <if test="payMoney != null">
                pay_money = #{payMoney,jdbcType=DECIMAL},
            </if>
            <if test="operatorCode != null">
                operator_code = #{operatorCode,jdbcType=VARCHAR},
            </if>
            <if test="operatorArea != null">
                operator_area = #{operatorArea,jdbcType=VARCHAR},
            </if>
            <if test="payMode != null">
                pay_mode = #{payMode,jdbcType=VARCHAR},
            </if>
            <if test="pushTel != null">
                push_tel = #{pushTel,jdbcType=VARCHAR},
            </if>
            <if test="pushMail != null">
                push_mail = #{pushMail,jdbcType=VARCHAR},
            </if>
            <if test="reconciliationsFlag != null">
                reconciliations_flag = #{reconciliationsFlag,jdbcType=VARCHAR},
            </if>
            <if test="notes != null">
                notes = #{notes,jdbcType=VARCHAR},
            </if>
            <if test="memo1 != null">
                memo1 = #{memo1,jdbcType=VARCHAR},
            </if>
            <if test="memo2 != null">
                memo2 = #{memo2,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                create_date = #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="createUser != null">
                create_user = #{createUser,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updateUser != null">
                update_user = #{updateUser,jdbcType=VARCHAR},
            </if>
        </set>
        where primary_id = #{primaryId,jdbcType=VARCHAR}
    </update>
    <update id="updateByPrimaryKey" parameterType="cn.plou.web.charge.chargeconfig.entity.BankReconciliationsDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update bank_reconciliations_detail
        set company_id = #{companyId,jdbcType=VARCHAR},
        annual = #{annual,jdbcType=VARCHAR},
        bank_id = #{bankId,jdbcType=VARCHAR},
        platform_code = #{platformCode,jdbcType=VARCHAR},
        consumer_id = #{consumerId,jdbcType=VARCHAR},
        third_party_flow_code = #{thirdPartyFlowCode,jdbcType=VARCHAR},
        pay_date = #{payDate,jdbcType=TIMESTAMP},
        pay_money = #{payMoney,jdbcType=DECIMAL},
        operator_code = #{operatorCode,jdbcType=VARCHAR},
        operator_area = #{operatorArea,jdbcType=VARCHAR},
        pay_mode = #{payMode,jdbcType=VARCHAR},
        push_tel = #{pushTel,jdbcType=VARCHAR},
        push_mail = #{pushMail,jdbcType=VARCHAR},
        reconciliations_flag = #{reconciliationsFlag,jdbcType=VARCHAR},
        notes = #{notes,jdbcType=VARCHAR},
        memo1 = #{memo1,jdbcType=VARCHAR},
        memo2 = #{memo2,jdbcType=VARCHAR},
        create_date = #{createDate,jdbcType=TIMESTAMP},
        create_user = #{createUser,jdbcType=VARCHAR},
        update_date = #{updateDate,jdbcType=TIMESTAMP},
        update_user = #{updateUser,jdbcType=VARCHAR}
        where primary_id = #{primaryId,jdbcType=VARCHAR}
    </update>

    <select id="getBankOnly" resultType="cn.plou.web.charge.chargeconfig.dto.DoChargeDTO" resultMap="BaseResultMap">
        SELECT b.primary_id
        FROM
            bank_reconciliations_detail b
        WHERE
            DATE_FORMAT(b.pay_date, '%Y%m%d') = #{reconciliationsDate,jdbcType=VARCHAR}
            AND b.company_id = #{companyId,jdbcType=VARCHAR}
            AND b.annual = #{annual,jdbcType=VARCHAR}
            AND b.bank_id = #{bankId,jdbcType=VARCHAR}
            AND b.platform_code = #{platformCode,jdbcType=VARCHAR}
            AND NOT EXISTS(
                    SELECT 1
                    FROM
                        user_year_account_detail u
                    WHERE
                        DATE_FORMAT(u.account_time, '%Y%m%d') = #{reconciliationsDate,jdbcType=VARCHAR}
                        AND u.company_id = #{companyId,jdbcType=VARCHAR}
                        AND u.annual = #{annual,jdbcType=VARCHAR}
                        AND u.third_consumer_id = b.third_party_flow_code
            )
    </select>

    <select id="getChargeEqual" resultType="cn.plou.web.charge.chargeconfig.dto.DoChargeDTO" resultMap="BaseResultMap">
        SELECT b.primary_id
        FROM
            bank_reconciliations_detail b
            LEFT JOIN user_year_account_detail u ON u.third_consumer_id = b.third_party_flow_code
        WHERE
            b.third_party_flow_code IS NOT NULL
            AND u.primary_id IS NOT NULL
            AND DATE_FORMAT(b.pay_date, '%Y%m%d') = #{reconciliationsDate,jdbcType=VARCHAR}
            AND b.company_id = #{companyId,jdbcType=VARCHAR}
            AND b.annual = #{annual,jdbcType=VARCHAR}
            AND b.bank_id = #{bankId,jdbcType=VARCHAR}
            AND b.platform_code = #{platformCode,jdbcType=VARCHAR}
            AND u.company_id = #{companyId,jdbcType=VARCHAR}
            AND u.annual = #{annual,jdbcType=VARCHAR}
            AND DATE_FORMAT(u.account_time, '%Y%m%d') = #{reconciliationsDate,jdbcType=VARCHAR}
            AND (b.pay_money - u.account_cost = 0)
    </select>

    <select id="getChargeNotEqual" resultType="cn.plou.web.charge.chargeconfig.dto.DoChargeDTO" resultMap="BaseResultMap">
        SELECT b.primary_id
        FROM
            bank_reconciliations_detail b
            LEFT JOIN user_year_account_detail u ON u.third_consumer_id = b.third_party_flow_code
        WHERE
            b.third_party_flow_code IS NOT NULL
            AND u.primary_id IS NOT NULL
            AND DATE_FORMAT(b.pay_date, '%Y%m%d') = #{reconciliationsDate,jdbcType=VARCHAR}
            AND b.company_id = #{companyId,jdbcType=VARCHAR}
            AND b.annual = #{annual,jdbcType=VARCHAR}
            AND b.bank_id = #{bankId,jdbcType=VARCHAR}
            AND b.platform_code = #{platformCode,jdbcType=VARCHAR}
            AND u.company_id = #{companyId,jdbcType=VARCHAR}
            AND u.annual = #{annual,jdbcType=VARCHAR}
            AND DATE_FORMAT(u.account_time, '%Y%m%d') = #{reconciliationsDate,jdbcType=VARCHAR}
            AND (b.pay_money - u.account_cost &lt;&gt; 0)
    </select>

    <update id="updateReconciliationsFlag">
        update bank_reconciliations_detail
        set reconciliations_flag = #{flag,jdbcType=VARCHAR}
        where primary_id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.primaryId,jdbcType=VARCHAR}
        </foreach>
    </update>

    <select id="generalLedgerList" parameterType="cn.plou.web.charge.chargeconfig.dto.LedgerDetailSearchDTO" resultType="cn.plou.web.charge.chargeconfig.vo.LedgerDetailListVO">
        select
        primary_id,
        d.company_id,
        c.company_name,
        annual,
        bank_id,
        t1.type_name as bankName,
        platform_code, d.consumer_id, third_party_flow_code,
        pay_date, pay_money, operator_code, operator_area, pay_mode, push_tel, push_mail,
        reconciliations_flag,
        t2.type_name as reconciliationsFlagName,
        d.notes, d.memo1, d.memo2, d.create_date, d.create_user, d.update_date,
        d.update_user,
        h.address as address
        from bank_reconciliations_detail d
        left JOIN company_info c ON d.company_id = c.company_id
        left join houses_info h on h.consumer_id = d.consumer_id
        left join type_mst t1 on t1.id = d.bank_id
        left join type_mst t2 on t2.id = d.reconciliations_flag
        where
        <choose>
            <when test="rangeId.length == 6">
                substring(consumer_id,1,10) in
                (select commuity_id from commuity_info where station_id = #{rangeId,jdbcType=VARCHAR})
            </when>
            <otherwise>
                d.company_id = #{rangeId,jdbcType=VARCHAR}
            </otherwise>
        </choose>
        <if test="payDateStart != null">and DATE_FORMAT(d.pay_date,'%Y-%m-%d') &gt;= DATE_FORMAT(#{payDateStart,jdbcType=TIMESTAMP},'%Y-%m-%d')</if>
        <if test="payDateEnd != null">and DATE_FORMAT(d.pay_date,'%Y-%m-%d') &lt;= DATE_FORMAT(#{payDateEnd,jdbcType=TIMESTAMP},'%Y-%m-%d')</if>
        <if test="bankId != ''">and d.bank_id = #{bankId,jdbcType=VARCHAR}</if>
        <if test="annual != ''">and d.annual = #{annual,jdbcType=VARCHAR}</if>
        <if test="reconciliationsFlag != ''">and d.reconciliations_flag = #{reconciliationsFlag,jdbcType=VARCHAR}</if>
        <if test="thirdPartyFlowCode != ''">and d.third_party_flow_code = #{thirdPartyFlowCode,jdbcType=VARCHAR}</if>
        <if test="sortby != null and sortby != ''">
            order by ${sortby}
        </if>
        <if test="order != null and order != ''">
            ${order}
        </if>
    </select>
    <!-- ————————————————————————————————cache配置————————————————————————————  -->
    <cache eviction="FIFO" flushInterval="60000" size="1024"  readOnly="true"/>
</mapper>