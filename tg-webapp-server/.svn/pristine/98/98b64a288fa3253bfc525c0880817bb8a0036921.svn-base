package cn.plou.web.charge.chargeconfig.controller;

import java.util.Date;

import cn.plou.web.charge.chargeconfig.dto.BankChargeDTO;
import cn.plou.web.charge.chargeconfig.entity.BankInterfaceHistory;
import cn.plou.web.charge.chargeconfig.entity.UserYearAccountDetail;
import cn.plou.web.charge.chargeconfig.entity.UserYearHeat;
import cn.plou.web.charge.chargeconfig.entity.UserYearReceivableDetail;
import cn.plou.web.charge.chargeconfig.service.*;
import cn.plou.web.charge.chargeconfig.util.MoneyConverter;
import cn.plou.web.charge.chargeconfig.vo.AnnualsVO;
import cn.plou.web.charge.chargeconfig.vo.UserYearAccountDetailForOldYearVO;
import cn.plou.web.charge.chargeconfig.vo.UserYearHeatLateFee;
import cn.plou.web.charge.chargeconfig.vo.UserYearReceivableDetailInfo;
import cn.plou.web.common.config.common.BusinessException;
import cn.plou.web.common.config.common.Constant;
import cn.plou.web.common.config.common.Root;
import cn.plou.web.common.utils.CurrencyUtil;
import cn.plou.web.common.utils.FlowIdTool;
import cn.plou.web.common.utils.IDWorker;
import cn.plou.web.common.utils.UserUtils;
import cn.plou.web.system.baseMessage.commuity.entity.Commuity;
import cn.plou.web.system.baseMessage.commuity.service.CommuityService;
import cn.plou.web.system.baseMessage.house.entity.House;
import cn.plou.web.system.baseMessage.house.service.HouseService;
import cn.plou.web.system.baseMessage.house.vo.HouseInfo;
import cn.plou.web.system.commonMessage.typeMst.dao.TypeMstMapper;
import cn.plou.web.system.commonMessage.typeMst.entity.TypeMst;
import cn.plou.web.system.commonMessage.typeMst.service.TypeMstService;
import cn.plou.web.system.permission.userLogin.service.UserLoginService;
import com.github.pagehelper.PageInfo;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.LongSerializationPolicy;
import com.google.gson.reflect.TypeToken;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.apache.http.client.ClientProtocolException;
import org.apache.shiro.util.Assert;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

import javax.annotation.Resource;
import java.math.BigDecimal;
import java.text.DateFormat;
import java.text.DecimalFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.*;

import static cn.plou.web.common.config.common.Cond.getCond;

/**
 * @author panziqiang
 * 2018/8/17 14:27
 */

@RequestMapping("${chargePath}/costgather")
@RestController
@Api(description = "收费管理——费用收取")
@Slf4j
public class CostGatherController {

    @Autowired
    private ChargeAccountService chargeAccountService;
    @Resource
    private TypeMstService typeMstService;
    @Resource
    private UserYearReceivableDetailService userYearReceivableDetailService;
    @Resource
    private UserYearAccountDetailService userYearAccountDetailService;

    @Resource
    private UserYearHeatService userYearHeatService;

    @Resource
    private HouseService houseService;
    @Resource
    private CommuityService commuityService;

    @Resource
    private BankInterfaceHistoryService bankInterfaceHistoryService;
    @Resource
    private PriceDefineService priceDefineService;

    @Resource
    private TypeMstMapper typeMstMapper;

    @Resource
    UserLoginService userLoginService;

    @Resource
    CostManagementController  costManagementController;


    @ApiOperation(value = "根据关键字和用户id获取住户信息")
    @RequestMapping("/getHouseBySearchTextOrCompanyId")
    public Root getHouseBySearchTextOrCompanyId(@RequestParam(value = "searchText", required = false) String searchText,
                                                @RequestParam(value = "companyId", required = false) String companyId,
                                                @RequestParam(value = "order", required = false) String order,
                                                @RequestParam(value = "sortby", required = false) String sortby,
                                                @RequestParam Integer page,
                                                @RequestParam Integer pageSize) {

        Root root = new Root();
        PageInfo<House> pageInfo = houseService.getHouseBySearchTextOrId(searchText, companyId, order, sortby, page, pageSize);
        root.setData(pageInfo.getList());
        root.setCond(getCond(page, pageSize, (int) pageInfo.getTotal(),
                null, sortby));
        return root;

    }

    @ApiOperation(value = "根据采暖卡id获取住户信息")
    @RequestMapping("/getHouseByChargeIdOrTelOrIdcard")
    public Root getHouseByChargeIdOrTelOrIdcard(@RequestParam Map<String, Object> params) {
        Root root = new Root();
        //Assert.notNull(params.get("chargeId"), "chargeId can not be empty");
        String chargeId = params.get("chargeId") == null ? null : params.get("chargeId").toString();
        String tel = params.get("tel") == null ? null : params.get("tel").toString();
        String idcard = params.get("idcard") == null ? null : params.get("idcard").toString();
        String companyId = params.get("companyId") == null ? null : params.get("companyId").toString();

        if (chargeId == null && tel == null && idcard == null) {
            root.setCode(500);
            root.setMsg("请在charge_id、tel、idcard中，至少传递一个参数");
            return root;
        }
        root.setData(houseService.getHouseByChargeIdOrTelOrIdcardOrCompanyId(chargeId, tel, idcard, companyId));

        return root;
    }


    @ApiOperation(value = "获取 暖费收取 预收暖费信息")
    @RequestMapping("/getPreReceiveHeatInfo")
    public Root getPreReceiveHeatInfo(@RequestParam String consumerId,
                                      @RequestParam String annual,
                                      @RequestParam(value = "isClearChecked") boolean isClearChecked,
                                      @RequestParam(value = "paymentMethod") String paymentMethod,
                                      @RequestParam(value = "wantChange") boolean wantChange) {

        Root root = new Root();
        Integer page = 1;
        Integer pageSize = Integer.MAX_VALUE;

        //这里最好是从数据库里取一次，而不是这样取四次
        PageInfo<UserYearReceivableDetailInfo> userYearReceivableDetailsByConsumerId = userYearReceivableDetailService.getUserYearReceivableDetailsByConsumerId(consumerId, null, annual, null, null, page, pageSize);
        if (userYearReceivableDetailsByConsumerId.getTotal() == 0) {
            root.setCode(500);
            root.setMsg("用户年度采暖费用明细表没有记录");
            return root;
        }

        House houseById = houseService.getHouseById(consumerId);
        String chargeType = houseById.getChargeType();//供热收费类型

        UserYearHeat byUserAndAnnual = userYearHeatService.findByUserAndAnnual(consumerId, annual);
        if (byUserAndAnnual == null) {
            root.setCode(500);
            root.setMsg("用户年度采暖信息表没有记录");
            return root;
        }

        if (byUserAndAnnual.getSumAccount() == null) {
            byUserAndAnnual.setSumAccount(BigDecimal.ZERO);
        }
        if (byUserAndAnnual.getSumReceivable() == null) {
            byUserAndAnnual.setSumReceivable(BigDecimal.ZERO);
        }


        BigDecimal oldYearOweTotal = userYearHeatService.getOldYearOwe(consumerId, annual);//获取往年欠费
        oldYearOweTotal = oldYearOweTotal == null ? BigDecimal.ZERO : oldYearOweTotal;


        List<UserYearReceivableDetailInfo> list = userYearReceivableDetailsByConsumerId.getList();

        BigDecimal total = BigDecimal.ZERO;//预收合计
        BigDecimal areaTotal = BigDecimal.ZERO;//面积收费
        BigDecimal heatTotal = BigDecimal.ZERO;//热量收费
        BigDecimal otherTotal = BigDecimal.ZERO;//其他费用
        BigDecimal needTotal = byUserAndAnnual.getSumReceivable().subtract(byUserAndAnnual.getSumAccount()); //应缴金额
        for (UserYearReceivableDetailInfo userYearReceivableDetail : list) {
            if (userYearReceivableDetail.getChargingItem() != null && userYearReceivableDetail.getChargingItem().equals("charging_item_1")) {
                //面积费用

                areaTotal = userYearReceivableDetail.getTotal();
            }
            if (userYearReceivableDetail.getChargingItem() != null && userYearReceivableDetail.getChargingItem().equals("charging_item_2")) {
                //热量费用
                heatTotal = userYearReceivableDetail.getTotal();
            }
            total = total.add(userYearReceivableDetail.getTotal());
        }

        otherTotal = total.subtract(areaTotal.add(heatTotal));

        Map<String, Object> map = new HashMap<>();
        map.put("total", total);
        map.put("otherTotal", otherTotal);
        map.put("oldYearOweTotal", oldYearOweTotal);
        if (isClearChecked) {//如果勾选了清欠按钮
            needTotal = needTotal.add(oldYearOweTotal);
        }
        map.put("realNeedTotal", needTotal);//实际需要交的钱，有可能包含欠款。传回这个只是为了平账的时候用

        if (wantChange) { //若为找零模式则需要处理收费精度
            needTotal = MoneyConverter.Convert(consumerId.substring(0, 5), paymentMethod, needTotal);
        }
        map.put("needTotal", needTotal.toPlainString());


        if (chargeType.equals("charge_type_1")) {
            //面积收费
            map.put("areaTotal", areaTotal);
        } else if (chargeType.equals("charge_type_2")) {
            //二部制收费

            map.put("areaTotal", areaTotal);
            map.put("heatTotal", heatTotal);
        } else if (chargeType.equals("charge_type_3")) {
            //热计量收费
            map.put("heatTotal", heatTotal);
        }


        root.setCode(0);
        root.setData(map);
        return root;

    }


    @ApiOperation(value = "获取 日常收费 本季暖费信息，该接口主要供第三方调用")
    @RequestMapping("/getThisAnnualHeatFeeInfoEx")
    @Transactional
    public Map<String, Object> getThisAnnualHeatFeeInfoEx(@RequestParam Map<String, List<Map<String, Object>>> params) throws ClientProtocolException {

        Map<String, Object> mapRestlt = new HashMap<>();
        Map<String, Object> mapUser = new HashMap<>();
        List<Map<String, Object>> lstUser = new ArrayList<>();
        Root root = new Root();

        if (params == null) {
            return null;
        }
        Object objlst = params.get("lst");
        if (objlst == null) {
            return null;
        }
        String strlst = objlst.toString();

        Gson gson = new Gson();
//        GsonBuilder gb = new GsonBuilder();
//        gb.setLongSerializationPolicy(LongSerializationPolicy.STRING);
//        Gson gson = gb.create();
        //String gsonString =  gson.toJson(strlst);

        //Map<String, Collection<LinkedHashMap<String, String>>>
        //Map<String, Collection<LinkedHashMap<String, String>>> advDataMap = new Gson().fromJson(strlst, new TypeToken<Map<String, Collection<LinkedHashMap<String, String>>>>() {}.getType());


        List<Map<String, Object>> lst = gson.fromJson(strlst, List.class);

//        List<Map<String, String>> lst  = gson.fromJson(strlst,
//                new TypeToken< List<Map<String, String>>>() {
//                }.getType());

        if (lst == null || lst.size() == 0) {
            return null;
        }


        int i = 0;
        //List<String> consumerIdlst = new ArrayList<>();
        for (Map<String, Object> stringObjectMap : lst) {
            if (stringObjectMap.get("consumerId") == null) {
                throw new ClientProtocolException("获取参数consumerId失败" + i + "：");
            }
            if (stringObjectMap.get("annual") == null) {
                throw new ClientProtocolException("获取参数annual失败" + i + "：");
            }
            if (stringObjectMap.get("business_code") == null) {
                throw new ClientProtocolException("获取参数business_code失败" + i + "：");
            }
            if (stringObjectMap.get("bankIp") == null) {
                throw new ClientProtocolException("获取参数bankIp失败" + i + "：");
            }
            if (stringObjectMap.get("requestData") == null) {
                throw new ClientProtocolException("获取参数requestData失败" + i + "：");
            }
            if (stringObjectMap.get("requestDataDate") == null) {
                throw new ClientProtocolException("获取参数requestDataDate失败" + i + "：");
            }
            //consumerIdlst.add(stringObjectMap.get("consumerId").toString());

            String consumerId = stringObjectMap.get("consumerId").toString();
            String annual = stringObjectMap.get("annual").toString();
            String business_code = stringObjectMap.get("business_code").toString();


            String bankIp = stringObjectMap.get("bankIp").toString();


            //Map<String, Object> map1 = gson.fromJson(stringObjectMap.get("requestData"), Map.class);


            String requestData = stringObjectMap.get("requestData").toString();
            String requestDataDate = stringObjectMap.get("requestDataDate").toString();


            String chargeId = "";
            String address = "";
            String name = "";


            House houseById = houseService.getHouseById(consumerId);
            if (houseById != null) {
                chargeId = houseById.getChargeId();
                address = houseById.getAddress();
                name = houseById.getName();
            } else {

                SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
                String ymd = sdf.format(new Date());
                Map<String, Object> params2 = new HashMap<>();
                params2.put("companyId", houseById.getCompanyId());
                params2.put("annual", annual);
                params2.put("consumerId", consumerId);
                params2.put("bankId", bankIp);
                params2.put("businessCode", business_code);
                params2.put("requestData", requestData);
                params2.put("requestDataDate", requestDataDate);
                params2.put("returnData", "没有相关用户记录" + i + "：");
                params2.put("returnDataDate", ymd);
                params2.put("notes", "查询热费");

                Root root1 = null;
                try {
                    root1 = addBankInterfaceHistory(params2);
                } catch (Exception e) {
                    e.printStackTrace();
                    throw new ClientProtocolException("没有相关用户记录" + i + "：" + "添加银行履历失败1：" + e.getMessage());
                }

                if (root1.getCode() == 0) {
                    throw new ClientProtocolException("没有相关用户记录" + i + "：");
                } else {
                    //如果没有插入成功，那么就需要回滚事务。
                    throw new ClientProtocolException("没有相关用户记录" + i + "：" + "添加银行履历失败2：" + root1.getMsg());
                }

            }


            UserYearHeat byUserAndAnnual = userYearHeatService.findByUserAndAnnual(consumerId, annual);
            if (byUserAndAnnual == null) {
                root.setCode(500);
                root.setMsg("用户年度采暖信息表没有记录");


                SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
                String ymd = sdf.format(new Date());
                Map<String, Object> params2 = new HashMap<>();
                params2.put("companyId", houseById.getCompanyId());
                params2.put("annual", annual);
                params2.put("consumerId", consumerId);
                params2.put("bankId", bankIp);
                params2.put("businessCode", business_code);
                params2.put("requestData", requestData);
                params2.put("requestDataDate", requestDataDate);
                params2.put("returnData", "用户" + consumerId + "年度采暖信息表没有记录" + i + "：");
                params2.put("returnDataDate", ymd);
                params2.put("notes", "查询热费");

                Root root1 = null;
                try {
                    root1 = addBankInterfaceHistory(params2);
                } catch (Exception e) {
                    e.printStackTrace();
                    throw new ClientProtocolException("用户" + consumerId + "年度采暖信息表没有记录" + i + "：" + "添加银行履历失败3：" + e.getMessage());
                }
                if (root1.getCode() == 0) {
                    throw new ClientProtocolException("用户" + consumerId + "年度采暖信息表没有记录" + i + "：");
                } else {
                    //如果没有插入成功，那么就需要回滚事务。
                    throw new ClientProtocolException("用户" + consumerId + "年度采暖信息表没有记录" + i + "：" + "添加银行履历失败4：" + root1.getMsg());
                }


            }


            BigDecimal oldYearOweTotal = BigDecimal.ZERO;//往年欠费
            oldYearOweTotal = userYearHeatService.getOldYearOwe(consumerId, annual);//获取往年欠费
            if (oldYearOweTotal == null) {
                oldYearOweTotal = BigDecimal.ZERO;
            }

            Map<String, Object> map = getUserHeatFeeMapInfo(byUserAndAnnual, oldYearOweTotal);
            String payOver = byUserAndAnnual.getPayOver();
            String pay_state = "1";
            switch (payOver) {
                case "pay_over_1":
                    pay_state = "0";
                    break;
                default:
                    pay_state = "1";
                    break;
            }
            ;

            mapUser.put("consumer_id", consumerId==null?"":consumerId);
            mapUser.put("annual", annual==null?"":annual);
            mapUser.put("charge_id", chargeId==null?"":chargeId);
            mapUser.put("address", address==null?"":address);
            mapUser.put("name", name==null?"":name);
            mapUser.put("sum_receivable", map.get("needTotal")==null?"0":map.get("needTotal"));
            mapUser.put("pay_state", pay_state==null?"":pay_state);
            mapUser.put("notes", "");
            lstUser.add(mapUser);

            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            String ymd = sdf.format(new Date());
            Map<String, Object> params2 = new HashMap<>();
            params2.put("companyId", houseById.getCompanyId());
            params2.put("annual", annual);
            params2.put("consumerId", consumerId);
            params2.put("bankId", bankIp);
            params2.put("businessCode", business_code);
            params2.put("requestData", requestData);
            params2.put("requestDataDate", requestDataDate);


            Map<String, Object> eachMapResult = new HashMap<>();
            eachMapResult.put("return_code", "0000");
            eachMapResult.put("business_code", business_code);
            eachMapResult.put("tips", "查询成功");
            eachMapResult.put("user", lstUser);

            params2.put("returnData", "第" + (i + 1) + "次循环（共" + lst.size() + "次循环）的返回结果是：" + eachMapResult.toString());
            params2.put("returnDataDate", ymd);
            params2.put("notes", "查询热费");

            Root root1 = null;
            try {
                root1 = addBankInterfaceHistory(params2);
            } catch (Exception e) {
                e.printStackTrace();
                throw new ClientProtocolException("查询顺序" + i + "：" + "添加银行履历失败5：" + e.getMessage());
            }
            if (root1.getCode() != 0) {
                throw new ClientProtocolException("查询顺序" + i + "：" + "添加银行履历失败6：" + root1.getMsg());
            }


            i++;
        }


        String business_code = lst.get(0).get("business_code").toString();
        mapRestlt.put("return_code", "0000");
        mapRestlt.put("business_code", business_code);
        mapRestlt.put("tips", "查询成功");

        mapRestlt.put("user", lstUser);

        return mapRestlt;


    }


    @ApiOperation(value = "增加 第三方接入 记录履历信息，该接口主要供第三方调用")
    @RequestMapping("/addBankInterfaceHistory")
    @Transactional
    public Root addBankInterfaceHistory(@RequestParam Map<String, Object> params) {
        //加上锁，为了保持id的连贯性

        Map<String, Object> mapRestlt = new HashMap<>();
        Root root = new Root();

        String companyId = params.get("companyId") == null ? null : params.get("companyId").toString();
        String annual = params.get("annual") == null ? null : params.get("annual").toString();
        String consumerId = params.get("consumerId") == null ? null : params.get("consumerId").toString();
        String bankId = params.get("bankId") == null ? null : params.get("bankId").toString();
        String businessCode = params.get("businessCode") == null ? null : params.get("businessCode").toString();
        String requestData = params.get("requestData") == null ? null : params.get("requestData").toString();
        String requestDataDate = params.get("requestDataDate") == null ? null : params.get("requestDataDate").toString();
        String returnData = params.get("returnData") == null ? null : params.get("returnData").toString();
        String returnDataDate = params.get("returnDataDate") == null ? null : params.get("returnDataDate").toString();
        String notes = params.get("notes") == null ? null : params.get("notes").toString();

        String PrimaryId = null;
        synchronized (this) {

            DecimalFormat mFormat = new DecimalFormat("000000000000000000000000000000");
            BankInterfaceHistory lastBankInterfaceHistory = bankInterfaceHistoryService.findLastBankInterfaceHistory();
            Integer newPrimaryId = null;
            if (lastBankInterfaceHistory == null) {
                newPrimaryId = 0;
            } else {
                newPrimaryId = Integer.parseInt(lastBankInterfaceHistory.getPrimaryId());
            }
            newPrimaryId = newPrimaryId + 1;
            PrimaryId = mFormat.format(newPrimaryId);
            BankInterfaceHistory bankInterfaceHistory = new BankInterfaceHistory();
            bankInterfaceHistory.setPrimaryId(PrimaryId);
            bankInterfaceHistory.setCompanyId(companyId);
            bankInterfaceHistory.setAnnual(annual);
            bankInterfaceHistory.setConsumerId(consumerId);
            bankInterfaceHistory.setBankId(bankId);
            bankInterfaceHistory.setBusinessCode(businessCode);
            bankInterfaceHistory.setRequestData(requestData);
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            Date date1 = null;
            Date date2 = null;
            try {
                date1 = sdf.parse(requestDataDate);
                date2 = sdf.parse(returnDataDate);
            } catch (ParseException e) {
                e.printStackTrace();
            }
            bankInterfaceHistory.setRequestDataDate(date1);
            bankInterfaceHistory.setReturnData(returnData);
            bankInterfaceHistory.setReturnDataDate(date2);
            bankInterfaceHistory.setNotes(notes);

            int insert = bankInterfaceHistoryService.insert(bankInterfaceHistory);

            if (insert != 1) {
                root.setCode(500);
                root.setMsg("添加失败：" + bankInterfaceHistory.toString());
                return root;
            } else {
                root.setCode(0);
                root.setMsg("添加成功：" + bankInterfaceHistory.toString());
                return root;
            }

        }

    }

    @ApiOperation(value = "获取 日常收费 本季暖费信息")
    @RequestMapping("/getThisAnnualHeatFeeInfo")
    public Root getThisAnnualHeatFeeInfo(@RequestParam String consumerId,
                                         @RequestParam String annual,
                                         @RequestParam(value = "isClearChecked") boolean isClearChecked,
                                         @RequestParam(value = "paymentMethod") String paymentMethod) {

        Root root = new Root();
        UserYearHeat byUserAndAnnual = userYearHeatService.findByUserAndAnnual(consumerId, annual);
        if (byUserAndAnnual == null) {
            root.setCode(500);
            root.setMsg("用户年度采暖信息表没有记录");
            return root;
        }
        BigDecimal oldYearOweTotal = BigDecimal.ZERO;//往年欠费
        oldYearOweTotal = userYearHeatService.getOldYearOwe(consumerId, annual);//获取往年欠费
        if (oldYearOweTotal == null) {
            oldYearOweTotal = BigDecimal.ZERO;
        }

        Map<String, Object> map = getUserHeatFeeMapInfo(byUserAndAnnual, oldYearOweTotal);
        BigDecimal needTotal = (BigDecimal) (map.get("needTotal"));
        if (isClearChecked) {//如果勾选了清欠按钮
            needTotal = needTotal.add(oldYearOweTotal);//往年欠费
        }
        //处理收费精度
        needTotal = MoneyConverter.Convert(consumerId.substring(0, 5), paymentMethod, needTotal);
        map.put("needTotal", needTotal.toPlainString());

        root.setCode(0);
        root.setMsg("操作成功");
        root.setData(map);
        return root;

    }


    private Map<String, Object> getUserHeatFeeMapInfo(UserYearHeat userYearHeat, BigDecimal oldYearOweTotal) {
        if (userYearHeat.getSumAccount() == null) {
            userYearHeat.setSumAccount(BigDecimal.ZERO);
        }
        if (userYearHeat.getSumReceivable() == null) {
            userYearHeat.setSumReceivable(BigDecimal.ZERO);
        }

        BigDecimal receivableTotal = BigDecimal.ZERO;//费用合计
        BigDecimal accountTotal = BigDecimal.ZERO;//缴费合计
        BigDecimal needTotal = BigDecimal.ZERO;//应缴金额
        BigDecimal balanceTotal = BigDecimal.ZERO;//账户余额，这个应该是应缴金额的相反数。如果应缴金额为负数，那么应缴金额应该为0，而账户余额这时候应该是正数

        receivableTotal = userYearHeat.getSumReceivable();//费用合计
        accountTotal = userYearHeat.getSumAccount();//缴费合计
        String annual = userYearHeat.getAnnual();
        String companyId = userYearHeat.getCompanyId();


        //应缴金额
        //费用合计 大于 缴费合计
        if (receivableTotal.compareTo(accountTotal) == 1) {
            needTotal = receivableTotal.subtract(accountTotal);
        } else {
            needTotal = BigDecimal.ZERO;
        }

        balanceTotal = accountTotal.subtract(receivableTotal);//账户余额

        Map<String, Object> map = new HashMap<>();
        map.put("receivableTotal", receivableTotal);//费用合计
        map.put("accountTotal", accountTotal);//缴费合计
        map.put("oldYearOweTotal", oldYearOweTotal);//往年欠费
        map.put("needTotal", needTotal);//应缴金额——这个可以作为当年欠费（往年收费界面中的“陈欠合计”）
        map.put("balanceTotal", balanceTotal);//账户余额
        map.put("annual", annual);
        map.put("companyId", companyId);

        return map;
    }

    @ApiOperation(value = "获取 当前采暖季（为第三方调用）")
    @RequestMapping("/getCurrentHeatAnnualByConsumerIdEx")
    public Root getCurrentHeatAnnualByConsumerIdEx(@RequestParam Map<String, Object> params) {
        String consumerId = params.get("consumerId") == null ? null : params.get("consumerId").toString();
        consumerId = new Gson().fromJson(consumerId, String.class);
        return getCurrentHeatAnnualByConsumerId(consumerId);
    }


    @ApiOperation(value = "获取 当前采暖季")
    @RequestMapping("/getCurrentHeatAnnualByConsumerId")
    public Root getCurrentHeatAnnualByConsumerId(@RequestParam String consumerId) {
        return getCurrentHeatAnnualByCompanyId(consumerId.substring(0, 5));
    }

    @ApiOperation(value = "获取 当前采暖季")
    @RequestMapping("/getCurrentHeatAnnualByCompanyId")
    public Root getCurrentHeatAnnualByCompanyId(@RequestParam String companyId) {

        Root root = new Root();
        String currentHeatAnnual = priceDefineService.findCurrentHeatAnnual(companyId);
        root.setCode(0);
        root.setMsg("获取成功");
        root.setData(currentHeatAnnual);
        return root;
    }


    @ApiOperation(value = "往年收费 往年暖费陈欠信息")
    @RequestMapping("/getAllAnnualHeatFeeInfo")
    public Root getAllAnnualHeatFeeInfo(@RequestParam String consumerId, @RequestParam Integer page, @RequestParam Integer pageSize) {

        Root root = new Root();
        if (page == null) {
            page = 1;
        }
        if (pageSize == null) {
            pageSize = 10;
        }

        String currentHeatAnnual = priceDefineService.findCurrentHeatAnnual(consumerId.substring(0, 5));


        BigDecimal oldYearOweTotal = userYearHeatService.getOldYearOwe(consumerId, currentHeatAnnual);
        if (oldYearOweTotal == null) {
            oldYearOweTotal = BigDecimal.ZERO;
        }

        PageInfo<UserYearHeat> userYearHeats = userYearHeatService.findByUserForOldAnnual(consumerId, currentHeatAnnual, "desc", "annual", page, pageSize);

        //Map<String,Object> mapGlobal = new HashMap<>();
        TreeMap<String, Object> mapGlobal = new TreeMap<String, Object>(new Comparator<String>() {
            @Override
            public int compare(String o1, String o2) {
                return o1.compareTo(o2);
            }
        });

        List<Map<String, Object>> lst = new ArrayList<>();
        for (UserYearHeat userYearHeat : userYearHeats.getList()) {
            Map<String, Object> map = getUserHeatFeeMapInfo(userYearHeat, null);
            lst.add(map);
        }
        mapGlobal.put("detail", lst);
        mapGlobal.put("OweTotal", oldYearOweTotal);
//        mapGlobal.put("pages",userYearHeats.getPages());
        root.setCode(0);
        root.setData(mapGlobal);
        root.setCond(getCond(page, pageSize, (int) userYearHeats.getTotal(),
                null, "annual"));
        return root;

    }

    @ApiOperation(value = "获取 暖费收取 历年缴费记录")
    @RequestMapping("/getUserYearAccountDetail")
    public Root getUserYearAccountDetail(@RequestParam String consumerId,
                                         @RequestParam(value = "annual", required = false) String annual,
                                         @RequestParam(value = "order", required = false) String order,
                                         @RequestParam(value = "sortby", required = false) String sortby,
                                         @RequestParam Integer page,
                                         @RequestParam Integer pageSize) {

        Root root = new Root();

        PageInfo<UserYearAccountDetail> userYearAccountDetails = userYearAccountDetailService.findByUserAndAnnual(consumerId, annual, order, sortby, page, pageSize);

        root.setData(userYearAccountDetails.getList());
        root.setCond(getCond(page, pageSize, (int) userYearAccountDetails.getTotal(),
                null, sortby));
        return root;

    }


    @ApiOperation(value = "暖费管理 补打发票 点击打印按钮（会生成收据号）")
    @RequestMapping("/clickPrintButton")
    public Root clickPrintButton(@RequestParam String primaryId) {

        Root root = new Root();

        UserYearAccountDetail userYearAccountDetail = userYearAccountDetailService.selectByPrimaryKey(primaryId);
        if (userYearAccountDetail == null) {
            root.setCode(500);
            root.setMsg("获取不到缴费记录");
            return root;
        }

        String receiptno = userYearAccountDetail.getReceiptno();

        if (receiptno == null || receiptno.equals("")) {
            //如果收据号为空，会生成收据号
            TypeMst typeMst = typeMstMapper.getByTypeKbnAndTypeName(Constant.GLOBAL_BUSINESS_TYPE, Constant.GBT_RECEIPT_NO);
            if (typeMst == null) {
                root.setCode(500);
                root.setMsg("获取收据业务类型");
                return root;
            }
            String flowId = FlowIdTool.GetFlowId(userYearAccountDetail.getCompanyId(), typeMst.getTypeId());//收据号
            userYearAccountDetail.setReceiptno(flowId);

            userYearAccountDetailService.updateByPrimaryKey(userYearAccountDetail);
        }

        root.setCode(0);
        root.setMsg("生成成功");
        root.setData(userYearAccountDetail.getReceiptno());
        return root;

    }


    @ApiOperation(value = "暖费管理 补打发票 修改收据号")
    @RequestMapping("/changeReceiptno")
    public Root changeReceiptno(@RequestParam String primaryId, @RequestParam String receiptno) {

        Root root = new Root();

        if (receiptno.equals("")) {
            root.setCode(500);
            root.setMsg("收据号不能为空");
            return root;
        }
        UserYearAccountDetail userYearAccountDetail = userYearAccountDetailService.selectByPrimaryKey(primaryId);
        if (userYearAccountDetail == null) {
            root.setCode(500);
            root.setMsg("获取不到缴费记录");
            return root;
        }

        userYearAccountDetail.setReceiptno(receiptno);
        userYearAccountDetailService.updateByPrimaryKey(userYearAccountDetail);

        root.setCode(0);
        root.setMsg("修改收据号成功");
        root.setData(userYearAccountDetail.getReceiptno());
        return root;

    }

    @ApiOperation(value = "获取 暖费管理 补打发票 信息")
    @RequestMapping("/getUserYearAccountDetailPrintInfo")
    public Root getUserYearAccountDetailPrintInfo(@RequestParam List<String> primaryIds) {

        Root root = new Root();
        List<Map<String, Object>> eachMapResults = new ArrayList<>();
        for (String primaryId : primaryIds) {

            UserYearAccountDetail userYearAccountDetail = userYearAccountDetailService.selectByPrimaryKey(primaryId);
            if (userYearAccountDetail == null) {
                root.setCode(500);
                root.setMsg("获取不到缴费记录");
                return root;
            }

            String consumerId = userYearAccountDetail.getConsumerId();

            HouseInfo houseInfo = houseService.selectHouseInfoById(consumerId);
            if (houseInfo == null) {
                root.setCode(500);
                root.setMsg("获取不到对应的用户记录");
                return root;
            }

            Commuity community = commuityService.getCommuityById(consumerId.substring(0, 10));
            if (community == null) {
                root.setCode(500);
                root.setMsg("获取不到对应的小区");
                return root;
            }

            Map<String, Object> eachMapResult = new HashMap<>();

            String accountType = userYearAccountDetail.getAccountType();
            if (accountType == null) {
                root.setCode(500);
                root.setMsg("获取不到对应的交款方式");
                return root;
            }

            TypeMst typeMstById = typeMstService.getTypeMstById(accountType);

            if (accountType == null) {
                root.setCode(500);
                root.setMsg("获取不到" + accountType + "对应的交款方式枚举值");
                return root;
            }
            if (userYearAccountDetail.getAccountCost() == null) {
                root.setCode(500);
                root.setMsg("获取不到对应的交款金额");
                return root;
            }

            Date accountTime = userYearAccountDetail.getAccountTime();

            if (accountTime == null) {
                root.setCode(500);
                root.setMsg("获取不到对应的交款日期");
                return root;
            }

            SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日");
            String strAccountTime = sdf.format(accountTime);

            String accountCostChinaUpper = userYearAccountDetail.getAccountCost().toString();

            eachMapResult.put("companyName", houseInfo.getCompanyName());
            eachMapResult.put("userName", houseInfo.getName());
            eachMapResult.put("communityName", community.getCommuityName());
            eachMapResult.put("accountType", typeMstById.getTypeName());
            eachMapResult.put("accountCost", userYearAccountDetail.getAccountCost());
            eachMapResult.put("notes", userYearAccountDetail.getNotes());
            eachMapResult.put("accountTime", strAccountTime);
            eachMapResult.put("annual", userYearAccountDetail.getAnnual());
            eachMapResult.put("billNo", userYearAccountDetail.getBillno());
            eachMapResult.put("receiptno", userYearAccountDetail.getReceiptno());
            try {
                eachMapResult.put("accountCostChinaUpper", CurrencyUtil.toChinaUpper(accountCostChinaUpper));
            } catch (Exception e) {
                e.printStackTrace();
                root.setCode(500);
                root.setMsg("对应的交款金额转换人民币大写失败");
                return root;
            }
            eachMapResults.add(eachMapResult);
        }


        root.setCode(0);
        root.setMsg("转换成功");
        root.setData(eachMapResults);
        return root;

    }


    @ApiOperation(value = "增加 暖费收取 往年收费")
    @RequestMapping("/addUserYearAccountDetailForOldYear")
    @Transactional
    public Root addUserYearAccountDetailForOldYear(@RequestBody UserYearAccountDetailForOldYearVO userYearAccountDetailForOldYearVO) {

        Root root = new Root();

        BigDecimal accountCost = userYearAccountDetailForOldYearVO.getAccountCost();//实缴金额。
        BigDecimal needTotal = userYearAccountDetailForOldYearVO.getNeedTotal();//总的应缴金额
        List<AnnualsVO> annuals = userYearAccountDetailForOldYearVO.getAnnuals();
        String companyId = userYearAccountDetailForOldYearVO.getCompanyId();
        String consumerId = userYearAccountDetailForOldYearVO.getConsumerId();
        String accountType = userYearAccountDetailForOldYearVO.getAccountType();

        List<String> primaryids = new ArrayList<>();

        if (consumerId == null) {
            root.setCode(500);
            root.setMsg("请传入用户id");
            return root;
        }
        if (companyId == null) {
            root.setCode(500);
            root.setMsg("请传入公司id");
            return root;
        }
        if (accountCost.compareTo(needTotal) < 0) {//实缴金额 < 应缴金额
            root.setCode(500);
            root.setMsg("实缴金额 小于 应缴金额");
            return root;
        }

        if (annuals == null || annuals.size() == 0) {
            root.setCode(500);
            root.setMsg("请输入每年的具体缴费金额");
            return root;
        }


        for (AnnualsVO annual : annuals) {
            UserYearAccountDetail userYearAccountDetail = new UserYearAccountDetail();
            userYearAccountDetail.setThirdConsumerId(null);//先传null吧
            userYearAccountDetail.setCompanyId(companyId);
            userYearAccountDetail.setConsumerId(consumerId);
            userYearAccountDetail.setAnnual(annual.getAnnual());
            userYearAccountDetail.setAccountCost(annual.getNeedTotal());
            userYearAccountDetail.setAccountPointCost(null);//扣点 先传null吧
            userYearAccountDetail.setAccountType(accountType);//现金、刷卡、银行、微信、支付宝、网银等
            userYearAccountDetail.setAccountChannel(null);//大厅收费、移动支付、银行代收等
            userYearAccountDetail.setIsbill(null);
            userYearAccountDetail.setBillno(null);
            userYearAccountDetail.setBankName(null);
            userYearAccountDetail.setBankDept(null);
            userYearAccountDetail.setTeller(null);
            userYearAccountDetail.setAccountUser(null);
            userYearAccountDetail.setBankDept(null);
            userYearAccountDetail.setIsreconciliations(null);
            userYearAccountDetail.setNotes(null);//note 也需要前台传给我

            handleSingleToBeAddeDetail(userYearAccountDetail, new Date());

            //增加
            if (userYearAccountDetailService.insertSelective(userYearAccountDetail) == 1) {
                primaryids.add(userYearAccountDetail.getPrimaryId());

                Boolean aBoolean = updateUserYearHeat(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());//触发器
                if (aBoolean == false) {
                    throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,添加缴费记录失败");
                }

            } else {
                throw new RuntimeException("添加" + annual.getAnnual() + "年度缴费失败，触发回滚");
            }

        }

        String currentHeatAnnual = priceDefineService.findCurrentHeatAnnual(companyId);


        BigDecimal subtract = accountCost.subtract(needTotal);//实缴金额 减去 应缴金额 余下的那部分，插入当年缴费记录
        if (subtract.compareTo(BigDecimal.ZERO) == 1) {//真的多出来了,那就填充到当年采暖季的
            UserYearAccountDetail userYearAccountDetail = new UserYearAccountDetail();
            userYearAccountDetail.setThirdConsumerId(null);//先传null吧
            userYearAccountDetail.setCompanyId(companyId);
            userYearAccountDetail.setConsumerId(consumerId);
            userYearAccountDetail.setAnnual(currentHeatAnnual);
            userYearAccountDetail.setAccountCost(subtract);
            userYearAccountDetail.setAccountPointCost(null);//扣点 先传null吧
            userYearAccountDetail.setAccountType(null);//现金、刷卡、银行、微信、支付宝、网银等
            userYearAccountDetail.setAccountChannel(null);//大厅收费、移动支付、银行代收等
            userYearAccountDetail.setIsbill(null);
            userYearAccountDetail.setBillno(null);
            userYearAccountDetail.setBankName(null);
            userYearAccountDetail.setBankDept(null);
            userYearAccountDetail.setTeller(null);
            userYearAccountDetail.setAccountUser(null);
            userYearAccountDetail.setBankDept(null);
            userYearAccountDetail.setIsreconciliations(null);
            userYearAccountDetail.setNotes(null);//note 也需要前台传给我

            handleSingleToBeAddeDetail(userYearAccountDetail, new Date());

            //增加
            if (userYearAccountDetailService.insertSelective(userYearAccountDetail) == 1) {

                primaryids.add(userYearAccountDetail.getPrimaryId());
                Boolean aBoolean = updateUserYearHeat(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());//触发器
                if (aBoolean == false) {
                    throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,添加缴费记录失败");
                }

            } else {
                throw new RuntimeException("添加" + currentHeatAnnual + "年度缴费失败，触发回滚");
            }
        }


        root.setCode(0);
        root.setData(primaryids);
        root.setMsg("添加成功");
        return root;


    }


    @ApiOperation(value = "暖费收取 预收暖费+日常收费")
    @RequestMapping("/addUserYearAccountDetail")
    @Transactional
    public Root addUserYearAccountDetail(UserYearAccountDetail userYearAccountDetail) {
        Root root = new Root();
        root.setMsg("交费成功");
        List<String> primaryids = new ArrayList<>();//返回给前端用作打印收据、发票
        if (userYearAccountDetail.isClearChecked()) {//若勾选往年欠费，判断实缴金额是否大于等于欠费金额，否则不予交费
            if (userYearAccountDetail.getAccountCost().compareTo(userYearAccountDetail.getOldYearOweTotal()) < 0) {
                throw new BusinessException("缴费失败！缴费金额必须大于清欠金额");
            }
        }
        //只有1找零模式，并且2实际交的钱大于等于经过精度处理后的应缴金额，才需要处理金额精度做做平账处理，同时用户当年应缴费用也要另算（即useryearheat要更新）
        if (userYearAccountDetail.isWantChange()&&userYearAccountDetail.getAccountCost().compareTo(userYearAccountDetail.getNeedTotal())>=0) {
            BigDecimal difference = userYearAccountDetail.getNeedTotal().subtract(userYearAccountDetail.getRealNeedTotal());
            if (difference.doubleValue() != 0) {
                UserYearReceivableDetail differenceDetail = new UserYearReceivableDetail();
                differenceDetail.setPrimaryId(IDWorker.uuid());
                differenceDetail.setCompanyId(userYearAccountDetail.getCompanyId());
                differenceDetail.setConsumerId(userYearAccountDetail.getConsumerId());
                differenceDetail.setAnnual(userYearAccountDetail.getAnnual());
                differenceDetail.setChargingItem("charging_item_4");//费用调整
                differenceDetail.setSum(new BigDecimal("1"));//数量
                differenceDetail.setUnitPrice(difference);
                differenceDetail.setDiscount(new BigDecimal("1"));
                differenceDetail.setTotal(difference);
                differenceDetail.setCertufucate(null);
                differenceDetail.setApproveRes("");
                differenceDetail.setNotes("费用调整");
                differenceDetail.setCreateDate(new Date());
                String currentUserName = userLoginService.getUserLoginById(UserUtils.getUserId()).getUsername();
                differenceDetail.setCreateUser(currentUserName);
                differenceDetail.setUpdateDate(null);
                differenceDetail.setUpdateUser(null);
                differenceDetail.setApproveSerial(null);//暂时留空
                userYearReceivableDetailService.insert(differenceDetail);

                costManagementController.postUserYearReceivableDetail(differenceDetail,"add");
            }
        }
        //若勾选了往年清欠，并传了往年陈欠的值，则先把往年的欠费补收
        if (userYearAccountDetail.isClearChecked()) {
            String currentHeatAnnual = priceDefineService.findCurrentHeatAnnual(userYearAccountDetail.getConsumerId().substring(0, 5));
            BigDecimal oldYearOweTotal = userYearHeatService.getOldYearOwe(userYearAccountDetail.getConsumerId(), currentHeatAnnual);
            if (oldYearOweTotal == null) {
                throw new BusinessException("该用户不存在往年欠费数据");
            }

            PageInfo<UserYearHeat> userYearHeats = userYearHeatService.findByUserForOldAnnual(userYearAccountDetail.getConsumerId(), currentHeatAnnual, "desc", "annual", 1, Integer.MAX_VALUE);
            List<Map<String, Object>> lst = new ArrayList<>();
            for (UserYearHeat userYearHeat : userYearHeats.getList()) {
                Map<String, Object> map = getUserHeatFeeMapInfo(userYearHeat, null);
                lst.add(map);
            }
            BigDecimal totalOwe = BigDecimal.ZERO;
            for (Map<String, Object> map : lst) {//逐年还清欠款
                UserYearAccountDetail oweUserYearAccountDetail = new UserYearAccountDetail();
                oweUserYearAccountDetail.setThirdConsumerId(null);//先传null吧
                oweUserYearAccountDetail.setCompanyId(userYearAccountDetail.getCompanyId());
                oweUserYearAccountDetail.setConsumerId(userYearAccountDetail.getConsumerId());
                oweUserYearAccountDetail.setAnnual((String) map.get("annual"));
                Object needTotal = map.get("needTotal");
                if (needTotal == null) {
                    oweUserYearAccountDetail.setAccountCost(BigDecimal.ZERO);
                } else {
                    String s = needTotal.toString();
                    if (s.equals("")) {
                        oweUserYearAccountDetail.setAccountCost(new BigDecimal(s));
                    } else {
                        oweUserYearAccountDetail.setAccountCost(BigDecimal.ZERO);
                    }
                }
                oweUserYearAccountDetail.setAccountPointCost(null);//扣点 先传null吧
                oweUserYearAccountDetail.setAccountType(null);//现金、刷卡、银行、微信、支付宝、网银等
                oweUserYearAccountDetail.setAccountChannel(null);//大厅收费、移动支付、银行代收等
                oweUserYearAccountDetail.setIsbill(null);
                oweUserYearAccountDetail.setBillno(null);
                oweUserYearAccountDetail.setBankName(null);
                oweUserYearAccountDetail.setBankDept(null);
                oweUserYearAccountDetail.setTeller(null);
                oweUserYearAccountDetail.setAccountUser(null);
                oweUserYearAccountDetail.setBankDept(null);
                oweUserYearAccountDetail.setIsreconciliations(null);
                oweUserYearAccountDetail.setNotes(null);//note 也需要前台传给我
                handleSingleToBeAddeDetail(oweUserYearAccountDetail, new Date());
                primaryids.add(oweUserYearAccountDetail.getPrimaryId());
                totalOwe = totalOwe.add(oweUserYearAccountDetail.getAccountCost());
                //增加
                if (userYearAccountDetailService.insertSelective(oweUserYearAccountDetail) == 1) {
                    Boolean aBoolean = updateUserYearHeat(oweUserYearAccountDetail.getConsumerId(), oweUserYearAccountDetail.getAnnual());//触发器
                    if (!aBoolean) {
                        throw new BusinessException("该用户未生成用户采暖年度信息表中的记录,添加缴费记录失败");
                    }
                } else {
                    throw new BusinessException("添加" + map.get("annual") + "年度缴费失败，触发回滚");
                }
            }

            if (userYearAccountDetail.getOldYearOweTotal().compareTo(totalOwe) != 0) {
                throw new BusinessException("数据一致性出现错误，缴费失败！");
            }
        }

        if (userYearAccountDetail.isClearChecked()) {//若勾选往年欠费
            userYearAccountDetail.setAccountCost(userYearAccountDetail.getRealNeedTotal().subtract(userYearAccountDetail.getOldYearOweTotal()));
        }
        if (userYearAccountDetail.getAccountCost().compareTo(BigDecimal.ZERO) > 0) {//看看还了往年清欠还剩多少钱，如果没钱了也没必要再交今年的了
            //ok,还剩钱，开始收取当年暖费(交的钱得减去清欠的。)
            handleSingleToBeAddeDetail(userYearAccountDetail, new Date());
            //增加
            if (userYearAccountDetailService.insertSelective(userYearAccountDetail) == 1) {

                Boolean aBoolean = updateUserYearHeat(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());//触发器
                if (!aBoolean) {
                    throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,添加缴费记录失败");
                }
                primaryids.add(userYearAccountDetail.getPrimaryId());
            } else {
              throw new  BusinessException("交费失败！");
            }
        }
        root.setData(primaryids);
        return root;
    }


    @ApiOperation(value = "根据流水号 冲正(供第三方调用)")
    @RequestMapping("/reverseUserYearAccountDetailByThirdConsumerId")
    public Root reverseUserYearAccountDetailByThirdConsumerId(@RequestParam Map<String, Object> params) throws ClientProtocolException {
        Root root = new Root();

        Assert.notNull(params.get("thirdPartyFlowCode"), "thirdPartyFlowCode can not be empt");
        Assert.notNull(params.get("payMoney"), "payMoney can not be empt");
        Assert.notNull(params.get("operatorCode"), "operatorCode can not be empt");

        String thirdPartyFlowCode = params.get("thirdPartyFlowCode") == null ? null : params.get("thirdPartyFlowCode").toString();
        String payMoney = params.get("payMoney") == null ? null : params.get("payMoney").toString();
        String operatorCode = params.get("operatorCode") == null ? null : params.get("operatorCode").toString();


        String businessCode = params.get("businessCode") == null ? null : params.get("businessCode").toString();
        String bankIp = params.get("bankIp") == null ? null : params.get("bankIp").toString();
        String requestData = params.get("requestData") == null ? null : params.get("requestData").toString();
        String requestDataDate = params.get("requestDataDate") == null ? null : params.get("requestDataDate").toString();

        BigDecimal payMoneyEx = new BigDecimal(payMoney);

        List<UserYearAccountDetail> byThirdConsumerId = userYearAccountDetailService.findByThirdConsumerId(thirdPartyFlowCode);

        if (byThirdConsumerId == null || byThirdConsumerId.size() == 0) {
            root.setCode(500);
            root.setMsg("根据流水号查询不到对应的缴费记录");
            return root;
        } else if (byThirdConsumerId.size() == 2) {

            BigDecimal accountCost1 = byThirdConsumerId.get(0).getAccountCost();
            BigDecimal accountCost2 = byThirdConsumerId.get(1).getAccountCost();
            BigDecimal accountCostResult = accountCost1.add(accountCost2);
            if (accountCostResult.compareTo(BigDecimal.ZERO) == 0) {
                root.setCode(500);
                root.setMsg("该流水号已冲正");
                return root;
            } else {
                root.setCode(500);
                root.setMsg("业务出错，这笔流水号两次缴费额度分别为：" + accountCost1 + "和" + accountCost2 + "并没有冲正");
                return root;
            }

        } else if (byThirdConsumerId.size() > 2) {
            root.setCode(500);
            root.setMsg("根据流水号查询到多条缴费记录：" + byThirdConsumerId.toString());
            return root;
        }
        UserYearAccountDetail userYearAccountDetail1 = byThirdConsumerId.get(0);

        if (userYearAccountDetail1.getAccountCost().compareTo(payMoneyEx) != 0) {
            root.setCode(500);
            root.setMsg("冲正金额：" + payMoney + "不等于查询到的金额" + userYearAccountDetail1.getAccountCost());
            return root;
        }


        Root root1 = cancelUserYearAccountDetail(userYearAccountDetail1.getPrimaryId(), "第三方冲正", operatorCode);

        if (root1.getCode() == 0) {
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            String ymd = sdf.format(new Date());
            Map<String, Object> params2 = new HashMap<>();
            params2.put("companyId", userYearAccountDetail1.getCompanyId());
            params2.put("annual", userYearAccountDetail1.getAnnual());
            params2.put("consumerId", userYearAccountDetail1.getConsumerId());
            params2.put("bankId", bankIp);
            params2.put("businessCode", businessCode);
            params2.put("requestData", requestData);
            params2.put("requestDataDate", requestDataDate);

            Map<String, Object> eachMapResult = new HashMap<>();
            eachMapResult.put("return_code", "0000");
            eachMapResult.put("business_code", businessCode);
            eachMapResult.put("tips", "操作成功");

            params2.put("returnData", eachMapResult.toString());
            params2.put("returnDataDate", ymd);
            params2.put("notes", "冲正请求");

            Root root2 = null;
            try {
                root2 = addBankInterfaceHistory(params2);
            } catch (Exception e) {
                e.printStackTrace();
                throw new ClientProtocolException("添加失败" + "：" + "添加银行履历失败1：" + e.getMessage());
            }

            if (root2.getCode() == 0) {
                return root1;
            } else {
                //如果没有插入成功，那么就需要回滚事务。
                throw new ClientProtocolException("添加失败" + "：" + "添加银行履历失败2：" + root1.getMsg());
            }

        } else {
            return root1;
        }

    }


    /**
     * @Description: 检查银行对账参数
     * @Param: [param, msg]
     * @Return: void
     * @Author: youbc
     * @Date: 2018/9/13 9上午04
     */
    private void checkParam(String param, String msg) {
        if (StringUtils.isEmpty(param)) {
            String message = "请传入" + msg;
            log.error(message);
            throw new BusinessException(message);
        }
    }

    /**
     * @Description: 银行对账
     * @Param: [bankChargeDTO, bindingResult]
     * @Return: cn.plou.web.common.config.common.Root
     * @Author: youbc
     * @Date: 2018/9/11 15下午48
     */
    @PostMapping("bank-charge")
    @Transactional
    public Root bankCharge(@RequestParam Map<String, String> params) throws ClientProtocolException {
        String reconciliationsDate = params.get("reconciliationsDate");
        checkParam(reconciliationsDate, "对账日期");
        String bankIp = params.get("bankIp");
        checkParam(bankIp, "银行 IP");
        String platformCode = params.get("platformCode");
        checkParam(platformCode, "平台码");


        String businessCode = params.get("businessCode") == null ? null : params.get("businessCode").toString();
        //String bankIp = params.get("bankIp") == null ? null : params.get("bankIp").toString();
        String requestData = params.get("requestData") == null ? null : params.get("requestData").toString();
        String requestDataDate = params.get("requestDataDate") == null ? null : params.get("requestDataDate").toString();

        BankChargeDTO bankChargeDTO = new BankChargeDTO();
        bankChargeDTO.setReconciliationsDate(reconciliationsDate);
        bankChargeDTO.setBankIp(bankIp);
        bankChargeDTO.setPlatformCode(platformCode);
        List<Map<String, String>> list = chargeAccountService.bankCharge(bankChargeDTO);
        if (list == null || list.size() == 0) {
            throw new ClientProtocolException("对账失败" + "：" + "查找到的对账记录为空。");
        }

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        String ymd = sdf.format(new Date());

        for (Map<String, String> stringStringMap : list) {

            String companyId = stringStringMap.get("companyId");
            String annual = stringStringMap.get("annual");
            String consumerId = stringStringMap.get("consumerId");
            if (companyId == null || companyId.equals("")) {
                throw new ClientProtocolException("对账失败" + "：" + "对账记录对应的公司id为空。");
            }
            if (annual == null || annual.equals("")) {
                throw new ClientProtocolException("对账失败" + "：" + "对账记录对应的采暖季为空。");
            }
            if (consumerId == null || consumerId.equals("")) {
                throw new ClientProtocolException("对账失败" + "：" + "对账记录对应的用户id为空。");
            }

            Map<String, Object> params2 = new HashMap<>();
            params2.put("companyId", companyId);
            params2.put("annual", annual);
            params2.put("consumerId", consumerId);
            //上面先传的null，这里谋划一下该怎么传入这三个值，因为可能是多个
//        params2.put("companyId", userYearAccountDetail1.getCompanyId());
//        params2.put("annual", userYearAccountDetail1.getAnnual());
//        params2.put("consumerId", userYearAccountDetail1.getConsumerId());
            params2.put("bankId", bankIp);
            params2.put("businessCode", businessCode);
            params2.put("requestData", requestData);
            params2.put("requestDataDate", requestDataDate);

            Map<String, Object> eachMapResult = new HashMap<>();
            eachMapResult.put("return_code", "0000");
            eachMapResult.put("business_code", businessCode);
            eachMapResult.put("tips", "操作成功");

            params2.put("returnData", eachMapResult.toString());
            params2.put("returnDataDate", ymd);
            params2.put("notes", "银行对账");

            Root root2 = null;
            try {
                root2 = addBankInterfaceHistory(params2);
                if (root2.getCode() != 0) {
                    //如果没有插入成功，那么就需要回滚事务。
                    throw new ClientProtocolException("添加失败" + "：" + "添加银行履历失败1：" + root2.getMsg());
                }
            } catch (Exception e) {
                e.printStackTrace();
                throw new ClientProtocolException("添加失败" + "：" + "添加银行履历失败2：" + e.getMessage());
            }
        }

        return new Root();


    }


    @ApiOperation(value = "增加 暖费收取 预收暖费(供第三方调用)")
    @RequestMapping("/addUserYearAccountDetailEx")
    public Root addUserYearAccountDetailEx(@RequestParam Map<String, Object> params) throws ClientProtocolException {
        Root root = new Root();


//        验证码	verification_code
//        业务码	business_code
//        平台码	platform_code
//        代收方式	pay_mode
//        第三方流水号	third_party_flow_code
//        客户ID	consumer_id
//        采暖季	annual
//        交费金额	pay_money
//        交费时间	pay_date
//        操作员编号	operator_code
//        推票手机号	push_tel
//        推票邮箱	push_mail


        String consumerId = params.get("consumerId") == null ? null : params.get("consumerId").toString();
        String annual = params.get("annual") == null ? null : params.get("annual").toString();

        String payMode = params.get("payMode") == null ? null : params.get("payMode").toString();//1-柜台，2-网上银行，3-手机银行，4-微信，0-其他  注：如果不区分以上方式，此项传空。
        String thirdPartyFlowCode = params.get("thirdPartyFlowCode") == null ? null : params.get("thirdPartyFlowCode").toString();
        String payMoney = params.get("payMoney") == null ? null : params.get("payMoney").toString();
        String payDate = params.get("payDate") == null ? null : params.get("payDate").toString();
        String operatorCode = params.get("operatorCode") == null ? null : params.get("operatorCode").toString();
        String pushTel = params.get("pushTel") == null ? null : params.get("pushTel").toString();
        String pushMail = params.get("pushMail") == null ? null : params.get("pushMail").toString();


        String businessCode = params.get("businessCode") == null ? null : params.get("businessCode").toString();
        String bankIp = params.get("bankIp") == null ? null : params.get("bankIp").toString();
        String requestData = params.get("requestData") == null ? null : params.get("requestData").toString();
        String requestDataDate = params.get("requestDataDate") == null ? null : params.get("requestDataDate").toString();

        if (consumerId == null || consumerId.equals("")) {
            root.setCode(500);
            root.setMsg("consumerId参数缺失");
            return root;
        }
        if (annual == null || annual.equals("")) {
            root.setCode(500);
            root.setMsg("annual参数缺失");
            return root;
        }
        if (payMode == null || payMode.equals("")) {
            root.setCode(500);
            root.setMsg("payMode参数缺失");
            return root;
        }
        if (thirdPartyFlowCode == null || thirdPartyFlowCode.equals("")) {
            root.setCode(500);
            root.setMsg("thirdPartyFlowCode参数缺失");
            return root;
        }

        if (payMoney == null || payMoney.equals("")) {
            root.setCode(500);
            root.setMsg("payMoney参数缺失");
            return root;
        }
        if (payDate == null || payDate.equals("")) {
            root.setCode(500);
            root.setMsg("payDate参数缺失");
            return root;
        }
        if (operatorCode == null || operatorCode.equals("")) {
            root.setCode(500);
            root.setMsg("operatorCode参数缺失");
            return root;
        }
        //这里得加上必选参数判断
        Date date = null;
        DateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        try {
            date = format.parse(payDate);
        } catch (ParseException e) {
            e.printStackTrace();
        }

        UserYearAccountDetail userYearAccountDetail = new UserYearAccountDetail();

        userYearAccountDetail.setThirdConsumerId(thirdPartyFlowCode);
        userYearAccountDetail.setCompanyId(consumerId.substring(0, 5));
        userYearAccountDetail.setConsumerId(consumerId);
        userYearAccountDetail.setAnnual(annual);
        userYearAccountDetail.setAccountCost(new BigDecimal(payMoney));
        userYearAccountDetail.setAccountPointCost(null);
        userYearAccountDetail.setAccountTime(date);


        if (payMode != null) {
            switch (payMode) {
                case "0":
                    userYearAccountDetail.setAccountType(null);//其他？传null吧
                    break;
                case "1":
                    userYearAccountDetail.setAccountType("payment_method_1");//现金
                    break;
                case "2":
                    userYearAccountDetail.setAccountType("payment_method_2");//网上银行、手机银行，暂定为刷卡吧
                    break;
                case "3":
                    userYearAccountDetail.setAccountType("payment_method_2");//网上银行、手机银行，暂定为刷卡吧
                    break;
                case "4":
                    userYearAccountDetail.setAccountType("payment_method_3");
                    break;
                default:
                    root.setCode(500);
                    root.setMsg("payMode参数非法");
                    return root;
            }
        } else {
            userYearAccountDetail.setAccountType(null);
        }

        userYearAccountDetail.setAccountChannel("pay_channel_3");//这个应该是银行代收吧
        userYearAccountDetail.setIsbill(null);
        userYearAccountDetail.setBillno(null);
        userYearAccountDetail.setBankName(null);
        userYearAccountDetail.setBankDept(null);
        userYearAccountDetail.setTeller(operatorCode);
        userYearAccountDetail.setAccountUser(null);
        userYearAccountDetail.setIsreconciliations(null);
        userYearAccountDetail.setNotes("第三方接入平台入账");
        handleSingleToBeAddeDetail(userYearAccountDetail, date);

        //增加
        if (userYearAccountDetailService.insertSelective(userYearAccountDetail) == 1) {

            Boolean aBoolean = updateUserYearHeat(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());//触发器

            if (aBoolean == false) {
                throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,添加缴费记录失败");
            }

            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            String ymd = sdf.format(new Date());
            Map<String, Object> params2 = new HashMap<>();
            params2.put("companyId", consumerId.substring(0, 5));
            params2.put("annual", annual);
            params2.put("consumerId", consumerId);
            params2.put("bankId", bankIp);
            params2.put("businessCode", businessCode);
            params2.put("requestData", requestData);
            params2.put("requestDataDate", requestDataDate);

            Map<String, Object> eachMapResult = new HashMap<>();
            eachMapResult.put("return_code", "0000");
            eachMapResult.put("business_code", businessCode);
            eachMapResult.put("tips", "操作成功");

            params2.put("returnData", eachMapResult.toString());
            params2.put("returnDataDate", ymd);
            params2.put("notes", "入账请求");

            Root root1 = null;
            try {
                root1 = addBankInterfaceHistory(params2);
            } catch (Exception e) {
                e.printStackTrace();
                throw new ClientProtocolException("添加失败" + "：" + "添加银行履历失败1：" + e.getMessage());
            }

            if (root1.getCode() == 0) {

            } else {
                //如果没有插入成功，那么就需要回滚事务。
                throw new ClientProtocolException("添加失败" + "：" + "添加银行履历失败2：" + root1.getMsg());
            }


            root.setCode(0);
            root.setMsg("添加成功");
            return root;
        } else {
            throw new ClientProtocolException("添加失败");
        }

    }


    private Boolean updateUserYearHeat(String consumerId, String annual) {
        BigDecimal totalByConsumerId = userYearAccountDetailService.getTotalByConsumerId(consumerId, annual);
        if (totalByConsumerId == null) totalByConsumerId = BigDecimal.ZERO;
        UserYearHeat byUserAndAnnual = userYearHeatService.findByUserAndAnnual(consumerId, annual);
        if (byUserAndAnnual == null) {
            return false;
        }
        byUserAndAnnual.setSumAccount(totalByConsumerId);
        BigDecimal sumReceivable = byUserAndAnnual.getSumReceivable();
        if (sumReceivable == null) sumReceivable = BigDecimal.ZERO;
        byUserAndAnnual.setMarginNow(totalByConsumerId.subtract(sumReceivable));
        userYearHeatService.updateByPrimaryKey(byUserAndAnnual);
        return true;
    }


    //这个表其实不涉及删除和修改，但是我还是把删除接口加上了。

    @ApiOperation(value = "删除 暖费收取 预收暖费")
    @RequestMapping("/deleteUserYearReceivableDetail")
    @Transactional
    public Root deleteUserYearReceivableDetail(@RequestParam String primaryId) {

        //此处需要考虑，是否需要判断这条记录是否有其他业务使用过。

        Root root = new Root();

        UserYearAccountDetail userYearAccountDetail = userYearAccountDetailService.selectByPrimaryKey(primaryId);
        if (userYearAccountDetail == null) {
            root.setCode(500);
            root.setMsg("预收暖费记录不存在：" + primaryId + "，请传入正常值");
            return root;
        }
        int i1 = userYearAccountDetailService.deleteByPrimaryKey(primaryId);
        if (i1 != 1) {
            root.setCode(500);
            root.setMsg("删除预收暖费数据记录：" + primaryId + "，失败");
            return root;
        }

        Boolean aBoolean = updateUserYearHeat(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());//触发器
        if (aBoolean == false) {
            throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,删除失败");
        }

        root.setCode(0);
        root.setMsg("删除预收暖费数据记录：" + primaryId + "，成功");
        return root;
    }


    //滞纳金计算公式：
    //从user_year_heat表（用户粘度采暖信息表）中取，因为这里全是入网用户
    //每个用户对应的热费单价类型，然后找到“热费单价类型表”price_define，然后用“用户年度采暖费用明细表”user_year_receivable_detail中，费用项目charging_item中的“金额”
    // （金额指的是除了面积费用、热量费用、滞纳金剩下的那些）,去在“热费单价类型表”price_define中滞纳金缴纳时间段内，乘以“热费单价类型表”price_define中的滞纳金率。每天计算一个滞纳金。
    //比如说，金额为100，滞纳金率为5%，那么每天会产生5元钱的滞纳金，每天五元钱。
    //所以这个要扫描所有的用户表，计算所有的情况，会比较消耗系统资源。

    @ApiOperation(value = "计算滞纳金，供任务调度")
    @RequestMapping("/calcLateFee")
    @Transactional
    public Root calcLateFee(@RequestParam String annual) {

        Root root = new Root();
        Integer page = 1;
        Integer pageSize = 200;

        Date currentTime = new Date();
        SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        String dateString = formatter.format(currentTime);


        PageInfo<UserYearHeatLateFee> userYearHeatLatesFeeForTotal = userYearHeatService.calcLateFee(annual, dateString, null, null, page, pageSize);
        PageInfo<UserYearHeatLateFee> userYearHeatsLateFee = null;

        int pages = userYearHeatLatesFeeForTotal.getPages();
        for (int i = 0; i < pages; i++) {

            currentTime = new Date();

            page = page + i;
            userYearHeatsLateFee = userYearHeatService.calcLateFee(annual, dateString, null, null, page, pageSize);
            List<UserYearHeatLateFee> list = userYearHeatsLateFee.getList();
            //开始批量修改
            List<UserYearReceivableDetail> userYearReceivableDetails = new ArrayList<>();
            for (UserYearHeatLateFee userYearHeatLateFee : list) {
                UserYearReceivableDetail userYearReceivableDetail = new UserYearReceivableDetail();
                //String annual = userYearHeatLateFee.getAnnual();
                String consumerId = userYearHeatLateFee.getConsumerId();
                String companyId = userYearHeatLateFee.getCompanyId();
                String lateFee = userYearHeatLateFee.getLateFee();

                userYearReceivableDetail.setCompanyId(companyId);
                userYearReceivableDetail.setConsumerId(consumerId);
                userYearReceivableDetail.setAnnual(annual);
                userYearReceivableDetail.setChargingItem("charging_item_7");
                userYearReceivableDetail.setSum(BigDecimal.ZERO);
                userYearReceivableDetail.setUnitPrice(BigDecimal.ZERO);
                userYearReceivableDetail.setDiscount(BigDecimal.ONE);
                userYearReceivableDetail.setTotal(new BigDecimal(lateFee));
                userYearReceivableDetail.setCreateDate(currentTime);
                userYearReceivableDetail.setCreateUser(UserUtils.getUserId());
                userYearReceivableDetail.setUpdateDate(currentTime);
                userYearReceivableDetail.setUpdateUser(UserUtils.getUserId());

                userYearReceivableDetails.add(userYearReceivableDetail);


            }

            userYearReceivableDetailService.batchUpdate(userYearReceivableDetails);

        }

        root.setCode(0);
        root.setData("生成滞纳金数据成功");
        return root;

    }


    @ApiOperation(value = "余额提现,传入的提现额度为正值，后台会转为负值")
    @RequestMapping("/balanceWithdrawCash")
    @Transactional
    public Root balanceWithdrawCash(UserYearAccountDetail userYearAccountDetail) {

        Root root = new Root();

        Assert.notNull(userYearAccountDetail.getConsumerId(), "传入的用户id不能为空");
        Assert.notNull(userYearAccountDetail.getAnnual(), "传入的采暖季不能为空");

        UserYearHeat userYearHeat = userYearHeatService.findByUserAndAnnual(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());
        if (userYearHeat == null) {
            //理论上不会走这里
            root.setCode(500);
            root.setMsg("获取不到用户采暖季数据");
            return root;
        }
        BigDecimal marginNow = userYearHeat.getMarginNow();//当前可以提现的余额

        BigDecimal withdrawCashValue = userYearAccountDetail.getAccountCost();// BigDecimal.ZERO.subtract(userYearAccountDetail.getAccountCost());

        userYearAccountDetail.setAccountType("payment_method_1");//提现 用现金吧


        if (withdrawCashValue.compareTo(marginNow) == 1) {
            root.setCode(500);
            root.setData("提现额度：" + withdrawCashValue + "大于余额：" + marginNow);
            return root;
        }


        String notesOld = userYearAccountDetail.getNotes();
        if (notesOld == null) {
            notesOld = "";
        }
        Date date = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        String strDate = sdf.format(date);
        String notesNew = "余额提现，提现额度：" + withdrawCashValue + " 时间：" + strDate + ";" + notesOld;
        if (notesNew.length() >= 255) {
            //理论上不会走这里
            root.setCode(500);
            root.setMsg("余额提现备注过长");
            return root;
        }
        userYearAccountDetail.setNotes(notesNew);
        withdrawCashValue = BigDecimal.ZERO.subtract(userYearAccountDetail.getAccountCost());
        userYearAccountDetail.setAccountCost(withdrawCashValue);
        return addUserYearAccountDetail(userYearAccountDetail);

    }


    @ApiOperation(value = "作废缴费记录")
    @RequestMapping("/cancelUserYearAccountDetail")
    @Transactional
    public Root cancelUserYearAccountDetail(@RequestParam String primaryId, @RequestParam String notes, @RequestParam(value = "teller", required = false) String teller) {

        Root root = new Root();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");


        UserYearAccountDetail userYearAccountDetail = userYearAccountDetailService.selectByPrimaryKey(primaryId);
        if (userYearAccountDetail == null) {
            root.setCode(500);
            root.setMsg("预收暖费记录不存在：" + primaryId + "，请传入正常值");
            return root;
        }
        userYearAccountDetail.setThirdConsumerId(userYearAccountDetail.getThirdConsumerId());

        userYearAccountDetail.setAccountPointCost(null);//扣点，还未完善，先设置为null

        String notesOld = userYearAccountDetail.getNotes();
        if (notesOld == null) {
            notesOld = "";
        }
        Date date = new Date();
        String strDate = sdf.format(date);
        String notesNew = "缴费作废,id：" + primaryId + " 时间：" + strDate + " 金额:" + userYearAccountDetail.getAccountCost() + " 作废原因：" + notes + ";" + notesOld;
        if (notesNew.length() >= 255) {
            root.setCode(500);
            root.setMsg("作废原因备注过长");
            return root;
        }
        userYearAccountDetail.setNotes(notesNew);

        userYearAccountDetail.setAccountCost(BigDecimal.ZERO.subtract(userYearAccountDetail.getAccountCost()));

        userYearAccountDetail.setTeller(teller);

        //创建人
        userYearAccountDetail.setCreateUser(UserUtils.getUserId());
        //创建时间
        userYearAccountDetail.setCreateDate(new Date());

        userYearAccountDetail.setAccountTime(new Date());


//        String PrimaryId = userYearAccountDetail.getConsumerId() + strDate;
//        userYearAccountDetail.setPrimaryId(PrimaryId);


        //开始收取当年暖费
        handleSingleToBeAddeDetail(userYearAccountDetail, date);
        //增加
        if (userYearAccountDetailService.insertSelective(userYearAccountDetail) == 1) {

            Boolean aBoolean = updateUserYearHeat(userYearAccountDetail.getConsumerId(), userYearAccountDetail.getAnnual());//触发器
            if (aBoolean == false) {
                throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,作废缴费记录失败");
            }

            root.setCode(0);
            root.setMsg("添加成功");
            return root;
        } else {

            root.setCode(500);
            root.setMsg("添加失败");
            return root;
        }


    }


    @ApiOperation(value = "批量收费—— 暖费收取 预收暖费")
    @RequestMapping("/addBatchUserYearAccountDetail")
    @Transactional
    public Root addBatchUserYearAccountDetail(@RequestBody List<UserYearAccountDetail> userYearAccountDetails) {
        Root root = new Root();
        for (UserYearAccountDetail detail : userYearAccountDetails) {
            handleSingleToBeAddeDetail(detail, new Date());
            //增加
            if (userYearAccountDetailService.insertSelective(detail) == 1) {

                Boolean aBoolean = updateUserYearHeat(detail.getConsumerId(), detail.getAnnual());//触发器
                if (aBoolean == false) {
                    throw new RuntimeException("该用户未生成用户采暖年度信息表中的记录,批量收费失败");
                }

            } else {
                root.setCode(500);
                root.setMsg("添加失败");
                return root;
            }
        }

        root.setCode(0);
        root.setMsg("添加成功");
        return root;


    }


    /**
     * @param mapList 格式：[{consumerId:xxxx,annual:xxxx}]
     * @return getBatchThisAnnualHeatFeeInfo
     */
    @ApiOperation(value = "批量收费——获取预收暖费信息")
    @RequestMapping("/getBatchPreReceiveHeatInfo")
    public Root getBatchPreReceiveHeatInfo(@RequestBody List<Map> mapList) {
        Root root = new Root();
        Integer page = 1;
        Integer pageSize = Integer.MAX_VALUE;
        String consumerId = "";
        String annual = "";
        List<Map> resultList = new ArrayList();
        for (Map paramMap : mapList) {
            consumerId = (String) paramMap.get("consumerId");
            annual = (String) paramMap.get("annual");

            PageInfo<UserYearReceivableDetailInfo> userYearReceivableDetailsByConsumerId = userYearReceivableDetailService.getUserYearReceivableDetailsByConsumerId(consumerId, null, annual, null, null, page, pageSize);
            if (userYearReceivableDetailsByConsumerId.getTotal() == 0) {
                root.setCode(500);
                root.setMsg("用户年度采暖费用明细表没有记录");
                return root;
            }

            House houseById = houseService.getHouseById(consumerId);
            String chargeType = houseById.getChargeType();//供热收费类型

            UserYearHeat byUserAndAnnual = userYearHeatService.findByUserAndAnnual(consumerId, annual);
            if (byUserAndAnnual == null) {
                root.setCode(500);
                root.setMsg("用户年度采暖信息表没有记录");
                return root;
            }

            if (byUserAndAnnual.getSumAccount() == null) {
                byUserAndAnnual.setSumAccount(BigDecimal.ZERO);
            }
            if (byUserAndAnnual.getSumReceivable() == null) {
                byUserAndAnnual.setSumReceivable(BigDecimal.ZERO);
            }


            BigDecimal oldYearOweTotal = userYearHeatService.getOldYearOwe(consumerId, annual);//获取往年欠费
            List<UserYearReceivableDetailInfo> list = userYearReceivableDetailsByConsumerId.getList();
            BigDecimal total = BigDecimal.ZERO;//预收合计
            BigDecimal areaTotal = BigDecimal.ZERO;//面积收费
            BigDecimal heatTotal = BigDecimal.ZERO;//热量收费
            BigDecimal otherTotal = BigDecimal.ZERO;//其他费用
            BigDecimal needTotal = byUserAndAnnual.getSumReceivable().subtract(byUserAndAnnual.getSumAccount()); //应缴金额
            for (UserYearReceivableDetail userYearReceivableDetail : list) {
                if (userYearReceivableDetail.getChargingItem() != null && userYearReceivableDetail.getChargingItem().equals("charging_item_1")) {
                    //面积费用
                    areaTotal = userYearReceivableDetail.getTotal();
                }
                if (userYearReceivableDetail.getChargingItem() != null && userYearReceivableDetail.getChargingItem().equals("charging_item_2")) {
                    //热量费用
                    heatTotal = userYearReceivableDetail.getTotal();
                }
                total.add(userYearReceivableDetail.getTotal());
            }

            otherTotal = total.subtract(areaTotal.add(heatTotal));

            Map<String, Object> map = new HashMap<>();
            map.put("total", total);
            map.put("otherTotal", otherTotal);
            map.put("oldYearOweTotal", oldYearOweTotal);
            map.put("needTotal", needTotal);

            if (chargeType.equals("charge_type_1")) {
                //面积收费
                map.put("areaTotal", areaTotal);
            } else if (chargeType.equals("charge_type_2")) {
                //二部制收费

                map.put("areaTotal", areaTotal);
                map.put("heatTotal", heatTotal);
            } else if (chargeType.equals("charge_type_3")) {
                //热计量收费

                map.put("heatTotal", heatTotal);
            }
            map.put("consumerId", consumerId);
            map.put("annual", annual);
            resultList.add(map);
        }
        root.setCode(0);
        root.setData(resultList);
        return root;
    }


    /**
     * 参数形式 [{consumerId:xxx,annual:xxx,order:xxxx,sortby:xxx,page:1,pageSize:10}]
     *
     * @return
     */
    @ApiOperation(value = "批量收费———— 获取历年缴费记录")
    @RequestMapping("/getBatchUserYearAccountDetail")
    public Object getBatchUserYearAccountDetail(
            @RequestBody List<Map> paramList) {

        List<Root> rootList = new ArrayList<>();
        Root root = null;
        String consumerId;
        String annual;
        String order;
        String sortby;
        Integer page;
        Integer pageSize;
        for (Map map : paramList) {
            root = new Root();
            consumerId = (String) map.get("consumerId");
            //houseService.getHouseById();
            annual = (String) map.get("annual");
            order = (String) map.get("order");
            sortby = (String) map.get("sortby");
            page = (Integer) map.get("page");
            pageSize = (Integer) map.get("pageSize");
            PageInfo<UserYearAccountDetail> userYearAccountDetails = userYearAccountDetailService.findByUserAndAnnual(consumerId, annual, order, sortby, page, pageSize);
            House house = houseService.getHouseById(consumerId);
            root.setMsg(house.getAddress() + (house.getName() == null ? "null" : house.getName()));
            root.setData(userYearAccountDetails.getList());
            root.setCond(getCond(page, pageSize, (int) userYearAccountDetails.getTotal(),
                    null, sortby));
            rootList.add(root);
        }


        return rootList;

    }


    private void handleSingleToBeAddeDetail(UserYearAccountDetail userYearAccountDetail, Date accountTime) {


        if (userYearAccountDetail.getConsumerId() == null || userYearAccountDetail.getConsumerId().equals("")) {
            throw new BusinessException("用户id：" + userYearAccountDetail.getConsumerId() + "，请传入正常值");
        }

        if (userYearAccountDetail.getCompanyId() == null || userYearAccountDetail.getCompanyId().equals("")) {
            throw new BusinessException("公司id：" + userYearAccountDetail.getCompanyId() + "，请传入正常值");
        }


        if (userYearAccountDetail.getAnnual() == null || userYearAccountDetail.getAnnual().equals("")) {
            throw new BusinessException("采暖年度：" + userYearAccountDetail.getAnnual() + "，请传入正常值");
        }


        List<String> typeKbns = new ArrayList<>();
        String typeKbn = "payment_method";
        typeKbns.add(typeKbn);
        List<TypeMst> downInfoByTypeKbns = typeMstService.getDownInfoByTypeKbns(typeKbns);

        List<String> ids = new ArrayList<String>();
        if (downInfoByTypeKbns != null && downInfoByTypeKbns.size() > 0) {
            for (int i = 0; i < downInfoByTypeKbns.size(); i++) {
                TypeMst typeMst = downInfoByTypeKbns.get(i);
                ids.add(typeMst.getId());
            }
        }

        if (!ids.contains(userYearAccountDetail.getAccountType())) {

            throw new BusinessException("缴费方式枚举值不存在：" + userYearAccountDetail.getAccountType() + "，请传入正常值");
        }


        //初始化其他字段

        //创建人
        userYearAccountDetail.setCreateUser(UserUtils.getUserId());
        //创建时间
        userYearAccountDetail.setCreateDate(new Date());

        userYearAccountDetail.setAccountTime(accountTime);

        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");

        Date now = new Date();
        String strDate = sdf.format(now);
        String thirdConsumerId = userYearAccountDetail.getThirdConsumerId();
        String PrimaryId = "";
        if (thirdConsumerId != null && thirdConsumerId.length() >= 5) {
            PrimaryId = userYearAccountDetail.getConsumerId() + strDate + thirdConsumerId.substring(thirdConsumerId.length() - 5);//再加上流水号（应该加五位流水号）
        } else {
            PrimaryId = userYearAccountDetail.getConsumerId() + strDate;
        }
        userYearAccountDetail.setPrimaryId(PrimaryId);
    }


}
